(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{389:function(s,a,n){"use strict";n.r(a);var t=n(18),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[s._v("#")]),s._v(" Nginx")]),s._v(" "),a("p",[s._v("Nginx 发行版本")]),s._v(" "),a("ul",[a("li",[s._v("https://nginx.org/ (开源版)")]),s._v(" "),a("li",[s._v("https://nginx.com/ (商业版)")]),s._v(" "),a("li",[s._v("https://tengine.taobao.org/ (开源版)")]),s._v(" "),a("li",[s._v("http://openresty.org/ (开源版)")]),s._v(" "),a("li",[s._v("https://openresty.com/ (商业版)")])]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.taohui.pub/categories/nginx/",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考-陶辉博客"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"源码编译安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源码编译安装"}},[s._v("#")]),s._v(" 源码编译安装")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# centos 准备 nginx 编译安装环境")]),s._v("\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 configure 支持的参数")]),s._v("\n./configure "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--help")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编译配置：会引用auto目录下的bash脚本")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 会在源代码目录中生成objs目录，其中 objs/ngx_modules.c 文件中包含接下来执行编译时有哪些模块会被编译进 nginx")]),s._v("\n./configure "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--prefix")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编译和链接")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make -j2 # 构建时使用 2 个线程编译，默认是 1 个线程编译")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装（覆盖式安装）：将链接出的文件拷贝至正确的位置（比如会覆盖掉/usr/local/nginx/）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("whereis")]),s._v(" nginx\n/usr/local/nginx/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v("\n/usr/local/nginx/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-V")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建软链")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" /usr/local/nginx/sbin/nginx /usr/bin/nginx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动")]),s._v("\n/usr/local/nginx/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" /usr/local/nginx/conf/nginx.conf\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /usr/local/nginx/sbin/nginx -s stop")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" localhost:80\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改配置文件后重载配置")]),s._v("\n/usr/local/nginx/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" reload\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试配置文件是否正确")]),s._v("\n/usr/local/nginx/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])]),a("h2",{attrs:{id:"nginx-配置语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-配置语法"}},[s._v("#")]),s._v(" Nginx 配置语法")]),s._v(" "),a("p",[s._v("Nginx 的配置文件语法遵循了 "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/INI_file",target:"_blank",rel:"noopener noreferrer"}},[s._v("INI"),a("OutboundLink")],1),s._v(" 格式，即以 "),a("code",[s._v("[section]")]),s._v(" 开始，以 "),a("code",[s._v(";")]),s._v(" 或 "),a("code",[s._v("#")]),s._v(" 开始的注释。")]),s._v(" "),a("ul",[a("li",[s._v("配置文件由指令与指令块构成")]),s._v(" "),a("li",[s._v("每条指令以 "),a("code",[s._v(";")]),s._v(" 结束，指令块以 "),a("code",[s._v("{")]),s._v(" 开始，以 "),a("code",[s._v("}")]),s._v(" 结束")]),s._v(" "),a("li",[s._v("指令块以 "),a("code",[s._v("{}")]),s._v(" 大括号将多条指令组织在一起")]),s._v(" "),a("li",[s._v("include 语句允许组合多个配置文件以提升维护性")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("#")]),s._v(" 添加注释")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("$")]),s._v(" 定义变量，变量名必须以字母或下划线开头，变量名不能包含特殊字符")]),s._v(" "),a("li",[s._v("部分指令的参数支持正则表达式")])]),s._v(" "),a("p",[s._v("配置参数-时间单位：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("ms")]),s._v(": milliseconds")]),s._v(" "),a("li",[a("code",[s._v("s")]),s._v(": seconds")]),s._v(" "),a("li",[a("code",[s._v("m")]),s._v(": minutes")]),s._v(" "),a("li",[a("code",[s._v("h")]),s._v(": hours")]),s._v(" "),a("li",[a("code",[s._v("d")]),s._v(": days")]),s._v(" "),a("li",[a("code",[s._v("w")]),s._v(": weeks")]),s._v(" "),a("li",[a("code",[s._v("M")]),s._v(": months,30 days")]),s._v(" "),a("li",[a("code",[s._v("y")]),s._v(": years,365 days")])]),s._v(" "),a("p",[s._v("配置参数-空间单位：")]),s._v(" "),a("ul",[a("li",[s._v("不加单位时默认为 bytes")]),s._v(" "),a("li",[a("code",[s._v("k/K")]),s._v(": kilobytes (1024 bytes)")]),s._v(" "),a("li",[a("code",[s._v("m/M")]),s._v(": megabytes (1024 k)")]),s._v(" "),a("li",[a("code",[s._v("g/G")]),s._v(": gigabytes (1024 m)")]),s._v(" "),a("li",[a("code",[s._v("t/T")]),s._v(": terabytes (1024 g)")]),s._v(" "),a("li",[a("code",[s._v("p/P")]),s._v(": petabytes (1024 t)")]),s._v(" "),a("li",[a("code",[s._v("e/E")]),s._v(": exabytes (1024 p)")]),s._v(" "),a("li",[a("code",[s._v("z/Z")]),s._v(": zettabytes (1024 e)")]),s._v(" "),a("li",[a("code",[s._v("y/Y")]),s._v(": yottabytes (1024 z)")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim 配置 nginx 语法高亮（默认情况下只有nginx.conf才能语法高亮，通过include引入的其他文件不行）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx *.conf文件Vim语法高亮问题：https://blog.csdn.net/weixin_45462681/article/details/117407402")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" /usr/local/nginx/contrib/vim/* ~/.vim/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"nginx-命令行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-命令行"}},[s._v("#")]),s._v(" Nginx 命令行")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 帮助: -h / -?")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打印版本信息: -v")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打印编译信息: -V")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-V")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用指定的配置文件: -c")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" /etc/nginx/myCustomNginx.conf\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试配置文件是否有语法错误: -t / -T")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发送信号: -s")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" stop "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 立刻停止服务")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" quit "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优雅地停止服务（等待当前请求处理完毕再停止）")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" reload "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新加载配置文件")]),s._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" reopen "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新开始记录日志文件")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定配置指令: -g")]),s._v("\n/usr/local/nginx/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-g")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pid /var/nginx/test.pid"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定运行目录: -p")]),s._v("\n/usr/local/nginx/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /usr/local/nginx/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Rotate the Nginx logs to prevent a single logfle from consuming too much disk space.")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用 crontab 定时分割日志示例：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 0 0 1 * * root /usr/local/nginx/logs/rotate.sh")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LOGS_PATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx/logs/history\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CUR_LOGS_PATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx/logs\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("YESTERDAY")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yesterday"')]),s._v(" +"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y%m%d"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CUR_LOGS_PATH}")]),s._v("/squirrel_access.log "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LOGS_PATH}")]),s._v("/squirrel_access_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${YESTERDAY}")]),s._v(".log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CUR_LOGS_PATH}")]),s._v("/squirrel_error.log "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LOGS_PATH}")]),s._v("/squirrel_error_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${YESTERDAY}")]),s._v(".log\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 向 Nginx 主进程发送 USR1 信号重新打开日志文件（等同于 nginx -s reopen）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-USR1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cat "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("logs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx.pid}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新打开日志 不会丢日志方式：（注意 mv 后再 reopen）")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置日志文件存放目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("logs_path")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/log/nginx/access/"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DAYS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置pid文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pid_path")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/nginx/logs/nginx.pid"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重命名日志文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${logs_path}")]),s._v("default.log "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${logs_path}")]),s._v("default-access_"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yesterday"')]),s._v(" +"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y%m%d"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(".log\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 向nginx主进程发信号重新打开日志")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-USR1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("pid_path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${logs_path}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default-access_*.log"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-type")]),s._v(" f "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-mtime")]),s._v(" +"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DAYS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h2",{attrs:{id:"ssl-tls"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssl-tls"}},[s._v("#")]),s._v(" SSL/TLS")]),s._v(" "),a("ul",[a("li",[s._v("SSL: Secure Socket Layer")]),s._v(" "),a("li",[s._v("TLS: Transport Layer Secure")])]),s._v(" "),a("p",[s._v("发展：")]),s._v(" "),a("ul",[a("li",[s._v("1995年，SSL3.0")]),s._v(" "),a("li",[s._v("1999年，TLS1.0")]),s._v(" "),a("li",[s._v("2006年，TLS1.1")]),s._v(" "),a("li",[s._v("2008年，TLS1.2")]),s._v(" "),a("li",[s._v("2018年，TLS1.3")])]),s._v(" "),a("p",[s._v("证书类型：")]),s._v(" "),a("ul",[a("li",[s._v("域名验证(domain validated, DV)证书")]),s._v(" "),a("li",[s._v("组织验证(organization validated, OV)证书")]),s._v(" "),a("li",[s._v("扩展验证(extended validated, EV)证书")])]),s._v(" "),a("p",[s._v("使用 "),a("a",{attrs:{href:"https://letsencrypt.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Let's Encrypt"),a("OutboundLink")],1),s._v(" 免费证书实现 https 站点")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" python2-certbot-nginx\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install certbot")]),s._v("\n\ncertbot "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v("\ncertbot "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v(" nginx\n\ncertbot "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--nginx")]),s._v(" --nginx-server-root"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/openresty/nginx/conf/ "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" example.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"进程管理-信号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进程管理-信号"}},[s._v("#")]),s._v(" 进程管理-信号")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/youth-blog/articles/16832451.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考博客"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("nginx 命令行")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("reload")]),s._v(": "),a("code",[s._v("HUP")])]),s._v(" "),a("li",[a("code",[s._v("reopen")]),s._v(": "),a("code",[s._v("USR1")])]),s._v(" "),a("li",[a("code",[s._v("stop")]),s._v(": "),a("code",[s._v("TERM")])]),s._v(" "),a("li",[a("code",[s._v("quit")]),s._v(": "),a("code",[s._v("QUIT")])])]),s._v(" "),a("p",[s._v("master 进程")]),s._v(" "),a("ul",[a("li",[s._v("监控 worker 进程\n"),a("ul",[a("li",[a("code",[s._v("CHILD")]),s._v(": master 是 worker 进程的父进程，在子进程退出时，Linux kernal 会向这个父进程发送信号 "),a("code",[s._v("SIGCHLD")])])])]),s._v(" "),a("li",[s._v("管理 worker 进程")]),s._v(" "),a("li",[s._v("接收信号\n"),a("ul",[a("li",[a("code",[s._v("TERM")]),s._v(", "),a("code",[s._v("INT")])]),s._v(" "),a("li",[a("code",[s._v("QUIT")])]),s._v(" "),a("li",[a("code",[s._v("HUP")])]),s._v(" "),a("li",[a("code",[s._v("USR1")])]),s._v(" "),a("li",[a("code",[s._v("USR2")]),s._v(" (只能通过 "),a("code",[s._v("kill -SIGUSR2 老master进程pid")]),s._v(" 使用，用于热升级)")]),s._v(" "),a("li",[a("code",[s._v("WINCH")]),s._v(" (只能通过 "),a("code",[s._v("kill -SIGWINCH 老master进程pid")]),s._v(" 使用，用于关闭所有的 worker 进程)")])])])]),s._v(" "),a("p",[s._v("worker 进程")]),s._v(" "),a("ul",[a("li",[s._v("接收信号\n"),a("ul",[a("li",[a("code",[s._v("TERM")]),s._v(", "),a("code",[s._v("INT")])]),s._v(" "),a("li",[a("code",[s._v("QUIT")])]),s._v(" "),a("li",[a("code",[s._v("USR1")])]),s._v(" "),a("li",[a("code",[s._v("WINCH")])])])])]),s._v(" "),a("h3",{attrs:{id:"reload-流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reload-流程"}},[s._v("#")]),s._v(" reload 流程")]),s._v(" "),a("ol",[a("li",[s._v("向 master 进程发送 "),a("code",[s._v("HUP")]),s._v(" 信号 (reload 命令)")]),s._v(" "),a("li",[s._v("master 进程校验配置语法是否正确")]),s._v(" "),a("li",[s._v("master 进程打开新的监听端口")]),s._v(" "),a("li",[s._v("master 进程用新配置启动新的 worker 子进程")]),s._v(" "),a("li",[s._v("master 进程向老的 worker 子进程发送 "),a("code",[s._v("QUIT")]),s._v(" 信号，让老 worker 子进程优雅的停止")]),s._v(" "),a("li",[s._v("老的 worker 子进程关闭监听句柄，处理完当前连接后结束进程")])]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),a("p",[s._v("nginx 优雅关闭主要针对 http 请求，而不是 tcp 或 websocket。因为 nginx 不会解析 tcp 的帧，也不会解析 websocket 的 frame，无法识别关闭的时机。")])]),s._v(" "),a("h3",{attrs:{id:"热升级流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热升级流程"}},[s._v("#")]),s._v(" 热升级流程")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.nginx.org.cn/article/detail/70",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考-如何在高并发环境中灰度升级Nginx？"),a("OutboundLink")],1)]),s._v(" "),a("ol",[a("li",[s._v("将旧 Nginx 文件换成新 Nginx 文件（注意备份）")]),s._v(" "),a("li",[s._v("向 master 进程发送 "),a("code",[s._v("USR2")]),s._v(" 信号\n"),a("ul",[a("li",[s._v("2.1 master 进程修改 pid 文件名，加后缀 .oldbin")]),s._v(" "),a("li",[s._v("2.2 master 进程用新 Nginx 配置文件启动新 master 进程")])])]),s._v(" "),a("li",[s._v("向老 master 进程发送 "),a("code",[s._v("WINCH")]),s._v(" 信号，告诉它请优雅的关闭你的所有的 worker 进程")]),s._v(" "),a("li",[s._v("确认升级正常后，向老 master 进程发送 "),a("code",[s._v("QUIT")]),s._v(" 信号，关闭老 master 进程")]),s._v(" "),a("li",[s._v("回滚：向老 master 发送 "),a("code",[s._v("HUP")]),s._v(" 信号，向新 master 发送 "),a("code",[s._v("QUIT")]),s._v(" 信号")])]),s._v(" "),a("p",[s._v("待理解概念：")]),s._v(" "),a("ul",[a("li",[s._v("TCP四元组")]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/chen19870707/article/details/42525887",target:"_blank",rel:"noopener noreferrer"}},[s._v("Epoll详解及源码分析"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("用户态、内核态")])])])}),[],!1,null,null,null);a.default=e.exports}}]);